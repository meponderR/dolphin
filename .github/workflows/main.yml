name: Dolphin-CI

on:
  push:
    branches: [ ios-jb ]
  pull_request:
    branches: [ ios-jb ]

jobs:
  ios:
    name: ios
    
    runs-on: macOS-latest
    
    steps:
    - name: Checkout Dolphin
      uses: actions/checkout@v2.1.0
      
    - name: Checkout submodules
      run: git submodule update --init --recursive
      
    - name: Install dependencies
      run: |
        brew install ninja bartycrouch dpkg s3cmd libmagic dos2unix
        pip3 install polib python-magic
        pod install
      working-directory: ./Source/iOS/DolphiniOS

    - name: Setup Workspace
      run: |
           rm DolphiniOS/BuildResources/BuildScripts/UpdateEntitlements.sh
           touch DolphiniOS/BuildResources/BuildScripts/UpdateEntitlements.sh
           chmod 755 DolphiniOS/BuildResources/BuildScripts/UpdateEntitlements.sh
           curl https://cdn.oatmealdome.me/dolphinios/ipa/DolphiniOS-NJB-2.2.2-1.ipa -o dolphinr.ipa
           unzip -q dolphinr.ipa -d releaseipa/
           cp -r releaseipa/Payload/DolphiniOS.app/GoogleService-Info.plist DolphiniOS/GoogleService-Info.plist
           mkdir ipas
      working-directory: ./Source/iOS/DolphiniOS

#    - name: Compile non-jailbroken ipa
#      run: |
#           xcodebuild archive -workspace DolphiniOS.xcworkspace -scheme DolphiniOS -archivePath DolphiniOS-njb.xcarchive -configuration "Debug (Non-Jailbroken)" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
#           cp -r DolphiniOS-njb.xcarchive/Products/Applications/ Payload/
#           echo "Start Codesign"
#           ldid -EDolphiniOS/BuildResources/Entitlements_PsychicPaper_Release.plist Payload/DolphiniOS.app/
#           ldid -EDolphiniOS/BuildResources/Entitlements_PsychicPaper_Release.plist Payload/DolphiniOS.app/Frameworks/*
#           echo "End Codesign"
#           zip -q -r ipas/Dolphin-njb.ipa Payload
#           rm -r Payload/
#      working-directory: ./Source/iOS/DolphiniOS
#      
#    - name: Upload non-jailbroken ipa
#      uses: actions/upload-artifact@v2
#      with:
#        name: DolphiniOS Beta (Non-Jailbroken)
#        path: Source/iOS/DolphiniOS/ipas/Dolphin-njb.ipa
      
    - name: Compile jailbroken App
      run: |
          xcodebuild archive -workspace DolphiniOS.xcworkspace -scheme DolphiniOS -archivePath DolphiniOS-jb.xcarchive -configuration "Debug (Jailbroken)" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          
          EXPORT_UUID=`uuidgen`
          EXPORT_PATH="/tmp/DolphiniOS-$EXPORT_UUID"
          DOLPHIN_EXPORT_PATH="$EXPORT_PATH/dolphin_deb_root/"
          CONTROL_FILE=DolphiniOS/BuildResources/DebFiles/control.in
          APPLICATION_DESTINATION_PATH=$DOLPHIN_EXPORT_PATH/Applications/DolphiniOS.app
          BUNDLE_ID="me.oatmealdome.DolphiniOS"
          VERSION_STRING=$(cat DolphiniOS.xcodeproj/project.pbxproj | grep -m1 'MARKETING_VERSION' | cut -d'=' -f2 | tr -d ';' | tr -d ' ')
          BUILD_NUMBER=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "DolphiniOS/Info.plist")
         
          cp -r "$ARCHIVE_PATH/Products/Applications/DolphiniOS.app" $APPLICATION_DESTINATION_PATH
          cp $ROOT_SRC_DIR/DolphiniOS/DolphiniOS/BuildResources/DebFiles/postinst.sh $DOLPHIN_EXPORT_PATH/DEBIAN/postinst
          cp $ROOT_SRC_DIR/DolphiniOS/DolphiniOS/BuildResources/DebFiles/postrm.sh $DOLPHIN_EXPORT_PATH/DEBIAN/postrm
          chmod -R 755 $DOLPHIN_EXPORT_PATH/DEBIAN/*
          sed "s/VERSION_NUMBER/$VERSION_STRING-$BUILD_NUMBER/g" $CONTROL_FILE > $DOLPHIN_EXPORT_PATH/DEBIAN/control
          plutil -replace "CFBundleIdentifier" -string "$BUNDLE_ID" $APPLICATION_DESTINATION_PATH/Info.plist
          
          dpkg-deb -b $DOLPHIN_EXPORT_PATH
          mv $EXPORT_PATH/dolphin_deb_root.deb $EXPORT_PATH/DolphiniOS.deb
          
          ::set-env name=JB_DEB_PATH::$EXPORT_PATH
           
      working-directory: ./Source/iOS/DolphiniOS
      
    - name: Upload jailbroken deb
      uses: actions/upload-artifact@v2
      with:
        name: DolphiniOS Beta (Jailbroken)
        path: ${JB_DEB_PATH}
